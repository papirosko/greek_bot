const fs = require("fs");
const path = require("path");
const https = require("https");
const crypto = require("crypto");

const SHEET_ID = "140tXKdn4CEpPCQcJ1DX6267IC7o8qjUwYbJCaMGy8GI";
const CREDS_PATH = path.resolve(
  __dirname,
  "..",
  "greek-bot-482410-e3d7e47dfa5c.json",
);

const topicsByLevel = {
  fact_a1: [
    [
      "Покупка в магазине",
      "Текст о покупке в магазине: человек купил 4-5 продуктов (например хлеб, молоко, сыр, яблоки, яйца). Вопрос (тип: отрицание): что НЕ было куплено. Используй синонимы для \"купил\".",
    ],
    [
      "Погода сегодня",
      "Факт о погоде сегодня: солнце, облака, ветер, температура. Вопрос (тип: событие): что случилось с погодой.",
    ],
    [
      "Утренний распорядок",
      "Текст о простом утре: проснулся, умылся, позавтракал, пошел в школу/на работу. Вопрос (тип: время): когда это произошло (утром/днем/вечером/ночью).",
    ],
    [
      "Транспорт в городе",
      "Факт о поездке: человек ехал на автобусе/метро/пешком. Вопрос (тип: событие): что произошло с поездкой (опоздал, успел, ждал).",
    ],
    [
      "Семья",
      "Текст о семье: мама, папа, брат/сестра, дедушка. Вопрос (тип: событие): что случилось в семье (встреча, ужин, разговор).",
    ],
    [
      "Еда в кафе",
      "Факт о заказе в кафе: заказал 4-5 блюд/напитков. Вопрос (тип: время): когда это произошло (утром/днем/вечером/ночью).",
    ],
    [
      "Покупки на рынке",
      "Факт о рынке: купил овощи и фрукты. Вопрос (тип: событие): что произошло на рынке (купил, выбирал, торговался).",
    ],
    [
      "Домашние дела",
      "Текст о делах дома: убрал, помыл посуду, вынес мусор, сделал покупку. Вопрос (тип: время): когда это было (утром/днем/вечером/ночью).",
    ],
    [
      "Парк и прогулка",
      "Факт о прогулке в парке: деревья, скамейка, дети, собака. Вопрос (тип: место): где это было (парк/улица/дом/школа).",
    ],
    [
      "Письмо другу",
      "Текст о коротком письме: привет, как дела, что делает. Вопрос (тип: содержание): что он сказал.",
    ],
    [
      "Шопинг утром",
      "Факт о походе в магазин утром: купил 4-5 продуктов. Вопрос (тип: время): когда было (утром/днем/вечером/ночью).",
    ],
    [
      "Ужин дома",
      "Текст о ужине: суп, салат, хлеб, вода. Вопрос (тип: содержание): что он ел.",
    ],
    [
      "Телефонный звонок",
      "Факт о звонке: позвонил маме, другу, врачу. Вопрос (тип: адресат): кому он звонил.",
    ],
    [
      "Погода вчера",
      "Факт о погоде вчера: дождь, ветер, холод. Вопрос (тип: состояние): что было на улице.",
    ],
    [
      "Покупка в аптеке",
      "Текст о покупке в аптеке: купил 4-5 простых вещей (витамины, пластырь, крем). Вопрос (тип: отрицание): что НЕ купил.",
    ],
    [
      "Школа и уроки",
      "Факт о школе: математика, чтение, письмо, музыка. Вопрос (тип: выбор): какой урок был.",
    ],
    [
      "Дом и комнаты",
      "Текст о доме: кухня, спальня, ванная, гостиная. Вопрос (тип: место): где он был.",
    ],
    [
      "Поездка вечером",
      "Факт о дороге: ехал вечером домой. Вопрос (тип: время): когда это было (утром/днем/вечером/ночью).",
    ],
    [
      "Встреча с другом",
      "Текст о встрече: кофе, разговор, прогулка. Вопрос (тип: действие): что они делали.",
    ],
    [
      "Покупка фруктов",
      "Факт о фруктах: купил 4-5 фруктов. Вопрос (тип: содержание): что он купил.",
    ],
    [
      "Почта",
      "Факт о почте: отправил письмо, получил посылку. Вопрос (тип: событие): что произошло.",
    ],
    [
      "День рождения",
      "Текст о дне рождения: торт, свечи, подарки. Вопрос (тип: содержание): что было на празднике.",
    ],
  ],
  fact_a2: [
    [
      "Покупка в супермаркете",
      "Текст о покупке: герой выбрал 4-5 продуктов, сравнил цены, взял акцию. Вопрос (тип: отрицание): что НЕ было куплено. Используй синонимы для \"товар\".",
    ],
    [
      "Поездка на выходные",
      "Факт о коротком путешествии: город, транспорт, одна активность. Вопрос (тип: время): когда это было (утром/днем/вечером/ночью).",
    ],
    [
      "Спорт",
      "Текст о тренировке: бег, плавание, велосипед, растяжка. Вопрос (тип: событие): что случилось на тренировке (начал/закончил/устал).",
    ],
    [
      "Праздник",
      "Факт о дне рождения: гости, подарки, торт, музыка. Вопрос (тип: время): когда был праздник (утром/днем/вечером/ночью).",
    ],
    [
      "Школьный день",
      "Текст о школе: уроки, домашнее задание, учитель, перемена. Вопрос (тип: событие): что случилось в школе (контрольная, ответ у доски, перемена).",
    ],
    [
      "Покупка одежды",
      "Факт о магазине одежды: купил 4-5 вещей, выбрал цвет/размер. Вопрос (тип: время): когда был поход в магазин (утром/днем/вечером/ночью).",
    ],
    [
      "Сезонные фрукты",
      "Факт о фруктах сезона: перечисли 4-5. Вопрос (тип: событие): что случилось на рынке (выбрал, попробовал, купил).",
    ],
    [
      "Домашнее животное",
      "Текст о питомце: еда, прогулка, игра, ветеринар. Вопрос (тип: время): когда это было (утром/днем/вечером/ночью).",
    ],
    [
      "Покупка техники",
      "Факт о покупке: телефон/наушники/зарядка. Вопрос (тип: содержание): что купил.",
    ],
    [
      "Здоровье",
      "Текст о визите к врачу: симптомы, советы, лекарства. Вопрос (тип: содержание): что сказал врач.",
    ],
    [
      "Путешествие по городу",
      "Факт о городе: музей, площадь, кафе, река. Вопрос (тип: место): где он был.",
    ],
    [
      "Фильм",
      "Текст о фильме: жанр, актеры, конец. Вопрос (тип: событие): что произошло в фильме.",
    ],
    [
      "План на неделю",
      "Факт о планах: работа, спорт, встреча, отдых. Вопрос (тип: план): что он планировал.",
    ],
    [
      "Покупки для дома",
      "Текст о магазине: купил 4-5 вещей для дома. Вопрос (тип: отрицание): что НЕ купил.",
    ],
    [
      "Вечер с друзьями",
      "Факт о вечере: ресторан, музыка, прогулка. Вопрос (тип: время): когда это было (утром/днем/вечером/ночью).",
    ],
    [
      "Проблема на работе",
      "Текст о работе: ошибка, решение, помощь. Вопрос (тип: событие): что случилось.",
    ],
    [
      "Подарок",
      "Факт о подарке: выбрал, купил, подарил. Вопрос (тип: адресат): кому он подарил.",
    ],
    [
      "Занятия языком",
      "Текст о языке: урок, упражнения, слова. Вопрос (тип: действие): что он делал.",
    ],
    [
      "Событие в школе",
      "Факт о школе: конкурс, выступление, награда. Вопрос (тип: событие): что произошло.",
    ],
    [
      "Поездка на море",
      "Текст о море: пляж, вода, солнце. Вопрос (тип: место): где он был.",
    ],
    [
      "Покупки в выходной",
      "Факт о выходном: магазин, список, скидки. Вопрос (тип: событие): что случилось.",
    ],
    [
      "Домашние дела вечером",
      "Текст о вечере: уборка, готовка, отдых. Вопрос (тип: время): когда это было.",
    ],
    [
      "Почта и документы",
      "Факт о документах: отправил/получил. Вопрос (тип: действие): что он сделал.",
    ],
  ],
  fact_b1: [
    [
      "Покупки и экология",
      "Факт о покупке с заботой об экологии: тканевые сумки, меньше пластика, сезонные продукты. Вопрос (тип: событие): что произошло во время покупки (выбрал, отказался, попросил).",
    ],
    [
      "Городская инфраструктура",
      "Текст о городских удобствах: велодорожки, парки, библиотеки, транспорт. Вопрос (тип: событие): что случилось в городе (открыли, обновили, закрыли).",
    ],
    [
      "История места",
      "Факт о городе или районе: возраст, известное здание, музей, событие. Вопрос (тип: время): когда произошло событие (утром/днем/вечером/ночью).",
    ],
    [
      "Музей и выставка",
      "Текст о визите в музей: 4-5 экспонатов/тем. Вопрос (тип: событие): что случилось в музее (экскурсия, выставка, лекция).",
    ],
    [
      "Питание и здоровье",
      "Факт о полезном рационе: овощи, цельные зерна, вода, меньше сахара. Вопрос (тип: изменение): что произошло с рационом (изменил, добавил, исключил).",
    ],
    [
      "Рабочий день",
      "Текст о проекте: встреча, дедлайн, отчет, планирование. Вопрос (тип: время): когда это было (утром/днем/вечером/ночью).",
    ],
    [
      "Традиции и кухня",
      "Факт о традиционном блюде: ингредиенты, как подают, когда едят. Вопрос (тип: событие): что случилось на празднике (приготовили, подали, попробовали).",
    ],
    [
      "Технологии в быту",
      "Текст о технологиях дома: умный свет, робот-пылесос, приложения. Вопрос (тип: событие): что произошло дома (установили, настроили, использовали).",
    ],
    [
      "Покупка на распродаже",
      "Факт о распродаже: сравнил цены, выбрал 4-5 товаров, сэкономил. Вопрос (тип: событие): что произошло на распродаже.",
    ],
    [
      "Обсуждение проекта",
      "Текст о проекте: задача, обсуждение, план, распределение ролей. Вопрос (тип: событие): что случилось на встрече.",
    ],
    [
      "Городская выставка",
      "Факт о выставке: тема, художники, место, билеты. Вопрос (тип: место): где проходила выставка.",
    ],
    [
      "Семейное событие",
      "Текст о семейной встрече: разговоры, планы, поездка. Вопрос (тип: время): когда это было (утром/днем/вечером/ночью).",
    ],
    [
      "Новости дня",
      "Факт о новости: событие, причина, последствия. Вопрос (тип: событие): что произошло.",
    ],
    [
      "Спорт и здоровье",
      "Текст о здоровье: обследование, врач, советы, питание. Вопрос (тип: содержание): что посоветовали.",
    ],
    [
      "Путешествие на поезде",
      "Факт о поездке: билет, маршрут, остановка, время. Вопрос (тип: время): когда это было.",
    ],
    [
      "Покупка для кухни",
      "Текст о кухне: купил 4-5 предметов, выбрал качество. Вопрос (тип: отрицание): что НЕ купил.",
    ],
    [
      "Местные продукты",
      "Факт о рынке: местные продукты, сезонность, цена. Вопрос (тип: событие): что случилось на рынке.",
    ],
    [
      "Волонтерство",
      "Текст о волонтерстве: помощь, организация, результат. Вопрос (тип: событие): что произошло.",
    ],
    [
      "Книга и чтение",
      "Факт о книге: жанр, сюжет, герой. Вопрос (тип: событие): что произошло в книге.",
    ],
    [
      "Рабочая поездка",
      "Текст о поездке: цель, встреча, итог. Вопрос (тип: причина/цель): зачем он поехал.",
    ],
    [
      "Городской парк",
      "Факт о парке: новые зоны, дорожки, события. Вопрос (тип: изменение): что изменилось.",
    ],
    [
      "Экономия дома",
      "Текст об экономии: свет, вода, покупки. Вопрос (тип: действие): что сделали.",
    ],
    [
      "Покупка подарков",
      "Факт о подарках: выбрал, сравнил, купил. Вопрос (тип: событие): что произошло.",
    ],
    [
      "Вечерняя программа",
      "Текст о вечере: театр, ужин, прогулка. Вопрос (тип: время): когда это было.",
    ],
  ],
  fact_b2: [
    [
      "Покупки и психология",
      "Факт о влиянии рекламы на покупки: импульс, скидки, планирование. Вопрос (тип: событие): что произошло перед покупкой (увидел, сравнил, решил).",
    ],
    [
      "Экономика семьи",
      "Текст о семейном бюджете: расходы, накопления, обязательные платежи, цели. Вопрос (тип: время): когда обсуждали бюджет (утром/днем/вечером/ночью).",
    ],
    [
      "Научное открытие",
      "Факт о научном открытии: год, ученый, результат, применение. Вопрос (тип: последствие): что произошло после открытия (применили, проверили, наградили).",
    ],
    [
      "Культурное событие",
      "Текст о фестивале: тема, участники, место, программа. Вопрос (тип: время): когда проходил фестиваль (утром/днем/вечером/ночью).",
    ],
    [
      "Городская политика",
      "Факт о решении городских властей: транспорт, зелёные зоны, налоги, жилье. Вопрос (тип: событие): что произошло на заседании (приняли, обсудили, отменили).",
    ],
    [
      "Путешествие и устойчивость",
      "Текст о устойчивом туризме: местные продукты, экология, транспорт. Вопрос (тип: событие): что случилось в поездке (выбрал, отказался, поддержал).",
    ],
    [
      "История искусства",
      "Факт о художнике: период, техника, знаменитая работа, влияние. Вопрос (тип: время): когда жил художник (утром/днем/вечером/ночью).",
    ],
    [
      "Медицина и профилактика",
      "Текст о профилактике: вакцинация, сон, физическая активность, питание. Вопрос (тип: изменение): что произошло в рекомендации (добавили, исключили, подчеркнули).",
    ],
    [
      "Покупательское поведение",
      "Факт о выборе товаров: сравнение, отзывы, рациональность. Вопрос (тип: причина): что повлияло на решение.",
    ],
    [
      "Городское планирование",
      "Текст о планах города: транспорт, жилье, экология, инвестиции. Вопрос (тип: решение): что решили сделать.",
    ],
    [
      "Научная конференция",
      "Факт о конференции: доклады, тема, участники, выводы. Вопрос (тип: событие): что произошло на конференции.",
    ],
    [
      "История компании",
      "Текст о компании: год основания, продукт, рост, рынок. Вопрос (тип: время): когда произошло событие.",
    ],
    [
      "Культурная критика",
      "Факт о рецензии: мнение, аргументы, оценка. Вопрос (тип: содержание): что сказал критик.",
    ],
    [
      "Экологические инициативы",
      "Текст о программе: цели, меры, результаты. Вопрос (тип: действие): что было сделано.",
    ],
    [
      "Образование и навыки",
      "Факт об обучении: курс, практики, результаты. Вопрос (тип: изменение): что изменилось после курса.",
    ],
    [
      "Технологический тренд",
      "Текст о тренде: влияние, сферы, примеры. Вопрос (тип: последствие): что случилось из-за тренда.",
    ],
    [
      "Финансовая стратегия",
      "Факт о стратегии: риск, диверсификация, доходность. Вопрос (тип: решение): что решили сделать.",
    ],
    [
      "Литературное направление",
      "Текст о направлении: авторы, особенности, период. Вопрос (тип: классификация): что относится к направлению.",
    ],
    [
      "Медицина и исследования",
      "Факт об исследовании: цель, метод, результат. Вопрос (тип: результат): что показало исследование.",
    ],
    [
      "Этика технологий",
      "Текст об этике: правила, риски, последствия. Вопрос (тип: тема): что обсуждали.",
    ],
    [
      "Социальная политика",
      "Факт о реформе: цель, меры, группы. Вопрос (тип: адресат): кого касалась реформа.",
    ],
    [
      "Искусство и рынок",
      "Текст о рынке искусства: цены, спрос, коллекции. Вопрос (тип: событие): что произошло на рынке.",
    ],
    [
      "Глобальные события",
      "Факт о событии: причины, последствия, реакция. Вопрос (тип: время): когда произошло событие.",
    ],
    [
      "Путешествие и культура",
      "Текст о поездке: традиции, кухня, встречи. Вопрос (тип: событие): что произошло в поездке.",
    ],
  ],
};

const requestedSheets = Object.keys(topicsByLevel);

const readCreds = () => {
  const raw = fs.readFileSync(CREDS_PATH, "utf8");
  const parsed = JSON.parse(raw);
  if (!parsed.client_email || !parsed.private_key) {
    throw new Error("Invalid service account JSON");
  }
  return parsed;
};

const requestToken = (account) => {
  const now = Math.floor(Date.now() / 1000);
  const header = { alg: "RS256", typ: "JWT" };
  const claims = {
    iss: account.client_email,
    scope: "https://www.googleapis.com/auth/spreadsheets",
    aud: "https://oauth2.googleapis.com/token",
    iat: now,
    exp: now + 3600,
  };

  const jwtHeader = Buffer.from(JSON.stringify(header))
    .toString("base64")
    .replace(/=/g, "")
    .replace(/\+/g, "-")
    .replace(/\//g, "_");
  const jwtClaims = Buffer.from(JSON.stringify(claims))
    .toString("base64")
    .replace(/=/g, "")
    .replace(/\+/g, "-")
    .replace(/\//g, "_");
  const toSign = `${jwtHeader}.${jwtClaims}`;
  const signature = crypto
    .createSign("RSA-SHA256")
    .update(toSign)
    .sign(account.private_key, "base64")
    .replace(/=/g, "")
    .replace(/\+/g, "-")
    .replace(/\//g, "_");
  const jwt = `${toSign}.${signature}`;

  const body = new URLSearchParams({
    grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
    assertion: jwt,
  }).toString();

  return new Promise((resolve, reject) => {
    const req = https.request(
      "https://oauth2.googleapis.com/token",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "Content-Length": Buffer.byteLength(body),
        },
      },
      (res) => {
        let data = "";
        res.on("data", (chunk) => (data += chunk));
        res.on("end", () => {
          if (res.statusCode !== 200) {
            return reject(
              new Error(`Token error ${res.statusCode}: ${data}`),
            );
          }
          const payload = JSON.parse(data);
          if (!payload.access_token) {
            return reject(new Error("Missing access token"));
          }
          resolve(payload.access_token);
        });
      },
    );
    req.on("error", reject);
    req.write(body);
    req.end();
  });
};

const apiRequest = (method, path, token, body) =>
  new Promise((resolve, reject) => {
    const payload = body ? JSON.stringify(body) : null;
    const req = https.request(
      `https://sheets.googleapis.com/v4/${path}`,
      {
        method,
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
          ...(payload ? { "Content-Length": Buffer.byteLength(payload) } : {}),
        },
      },
      (res) => {
        let data = "";
        res.on("data", (chunk) => (data += chunk));
        res.on("end", () => {
          if (res.statusCode && res.statusCode >= 300) {
            return reject(
              new Error(`Sheets error ${res.statusCode}: ${data}`),
            );
          }
          resolve(data ? JSON.parse(data) : {});
        });
      },
    );
    req.on("error", reject);
    if (payload) {
      req.write(payload);
    }
    req.end();
  });

const ensureSheets = async (token) => {
  const metadata = await apiRequest(
    "GET",
    `spreadsheets/${SHEET_ID}?fields=sheets.properties`,
    token,
  );
  const existing = new Set(
    (metadata.sheets || []).map((sheet) => sheet.properties?.title),
  );
  const requests = requestedSheets
    .filter((name) => !existing.has(name))
    .map((title) => ({
      addSheet: { properties: { title } },
    }));
  if (requests.length === 0) {
    return;
  }
  await apiRequest(
    "POST",
    `spreadsheets/${SHEET_ID}:batchUpdate`,
    token,
    { requests },
  );
};

const updateSheetValues = async (token, sheetName, rows) => {
  const values = [["title", "prompt"], ...rows];
  await apiRequest(
    "PUT",
    `spreadsheets/${SHEET_ID}/values/${encodeURIComponent(
      sheetName,
    )}!A1:B${values.length}?valueInputOption=RAW`,
    token,
    { range: `${sheetName}!A1:B${values.length}`, values },
  );
};

const run = async () => {
  const account = readCreds();
  const token = await requestToken(account);
  await ensureSheets(token);
  for (const [sheetName, rows] of Object.entries(topicsByLevel)) {
    await updateSheetValues(token, sheetName, rows);
  }
  console.log("Fact topics seeded.");
};

run().catch((error) => {
  console.error(error);
  process.exit(1);
});
